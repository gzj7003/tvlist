name: Project AHScript Automation

on:
  schedule:
    # 减少运行频率，避免被封IP（原为6次/天，现改为2次/天）
    - cron: '01 11,23 * * *'  # 北京时间 UTC+8 对应 19:01 和 07:01 点运行
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run workflow'
        required: true
        default: 'main'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 设置环境变量（如果需要使用FOFA API）
    env:
      FOFA_EMAIL: ${{ secrets.FOFA_EMAIL }}
      FOFA_TOKEN: ${{ secrets.FOFA_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies for OpenCV
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-glx libglib2.0-0

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install opencv-python-headless requests beautifulsoup4 lxml

      - name: Verify workspace
        run: |
          echo "Workspace: ${GITHUB_WORKSPACE}"
          ls -la
          if [ -d "set" ]; then
            echo "set directory exists"
            ls -la set/
          else
            echo "set directory does not exist"
          fi

      - name: Create necessary directories
        run: |
          mkdir -p udpah txt_files
          echo "测试文件" > udpah/test.txt

      - name: Execute script with retry mechanism
        # 添加重试机制，防止临时性失败
        continue-on-error: true
        run: |
          cd "${GITHUB_WORKSPACE}" || exit 1
          
          # 第一次尝试
          echo "第一次尝试运行脚本..."
          python ./ahitems.py || echo "第一次运行失败，等待后重试..."
          
          # 等待30秒后重试
          sleep 30
          
          # 第二次尝试
          echo "第二次尝试运行脚本..."
          python ./ahitems.py || echo "第二次运行失败，继续..."

      - name: Check for output files
        run: |
          if [ -d "txt_files" ]; then
            echo "生成的txt_files目录内容:"
            ls -la txt_files/
            echo ""
            echo "文件数量: $(ls txt_files/*.txt 2>/dev/null | wc -l)"
          else
            echo "txt_files目录不存在"
          fi

      - name: Commit and push changes if any
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查是否有变化
          git status
          
          # 添加所有变化
          git add .
          
          # 检查是否有需要提交的内容
          if git diff-index --quiet HEAD --; then
            echo "没有变化需要提交"
          else
            # 生成提交信息
            COMMIT_MSG="Auto-update: $(date +'%Y-%m-%d %H:%M:%S')"
            
            # 如果有txt文件生成，统计数量
            if [ -d "txt_files" ]; then
              TXT_COUNT=$(ls txt_files/*.txt 2>/dev/null | wc -l)
              if [ $TXT_COUNT -gt 0 ]; then
                COMMIT_MSG="$COMMIT_MSG - 生成 $TXT_COUNT 个播放列表"
              fi
            fi
            
            git commit -m "$COMMIT_MSG"
            git push origin HEAD:main
            echo "已提交并推送更改"
          fi

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            console.log('Workflow failed! Please check the logs.');
