name: Project AHScript Automation

on:
  schedule:
    - cron: '02 21,9 * * *'  # UTC时间，注意时区转换
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run workflow'
        required: true
        default: 'main'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify workspace structure
        run: |
          echo "Workspace path: ${GITHUB_WORKSPACE}"
          echo "Current directory structure:"
          find . -type f -name "*.py" | head -20
          if [ -f "ahitems.py" ]; then
            echo "✅ ahitems.py found"
          else
            echo "❌ ahitems.py not found!"
            exit 1
          fi

      - name: Execute script
        run: |
          python ./ahitems.py
        continue-on-error: false

      - name: Commit and push changes
        if: success()  # 只有脚本执行成功才提交
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 获取目标分支
          TARGET_BRANCH="${{ github.event.inputs.branch || 'main' }}"
          
          # 拉取最新变更
          git pull origin "$TARGET_BRANCH" --rebase || echo "No existing branch to pull from"
          
          # 检测变更
          git status
          git add .
          
          if ! git diff-index --quiet HEAD --; then
            git commit -m "Auto-update: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin "HEAD:$TARGET_BRANCH"
            echo "✅ Changes pushed to $TARGET_BRANCH"
          else
            echo "ℹ️ No changes to commit"
          fi
